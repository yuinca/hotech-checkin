
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>ä½ç½®é©—è­‰æ‰“å¡ç³»çµ±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; padding: 2em; text-align: center; }
        button { padding: 1em 2em; font-size: 1.2em; }
        #status { margin-top: 1em; font-weight: bold; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ“ å’Œå¾·æ‰“å¡ç³»çµ±</h1>
    <p>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹ä½ç½®é©—è­‰ä¸¦é€²è¡Œæ‰“å¡</p>
    <button onclick="handleClockIn()">é–‹å§‹æ‰“å¡</button>
    
    <div style="margin-top: 1em;">
        <input type="text" id="note" placeholder="è¼¸å…¥å‚™è¨»ï¼Œä¾‹å¦‚ï¼šåœ¨å…¬å¸å¤§é–€å£" style="padding: 0.5em; width: 80%; font-size: 1em;" />
    </div>
    <div id="status"></div>
    

    <script>
        const ALLOWED_LAT = 25.04504;
        const ALLOWED_LON = 121.46676;
        const ALLOWED_DISTANCE_KM = 0.1;

        const ODOO_URL = "https://hotech.odoo.com";
        const ODOO_API_KEY = "b59ac3b1a14a7ef6b143302ba951cbc18f955f58";
        const EMPLOYEE_ID = 1;

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function handleClockIn() {
            document.getElementById("status").textContent = "æ­£åœ¨å–å¾—ä½ç½®...";
            if (!navigator.geolocation) {
                alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ GPS å®šä½");
                return;
            }
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const dist = getDistance(lat, lon, ALLOWED_LAT, ALLOWED_LON);

                if (dist <= ALLOWED_DISTANCE_KM) {
                    document.getElementById("status").textContent = 
                        `âœ… ä½ç½®ç¢ºèª (${lat.toFixed(5)}, ${lon.toFixed(5)}ï¼Œè·é›¢: ${(dist*1000).toFixed(1)} å…¬å°º)`;
                    await sendAttendance();
                } else {
                    document.getElementById("status").textContent = 
                        `âŒ ä½ ä¸åœ¨æ‰“å¡å€åŸŸå…§ (ç›®å‰è·é›¢ ${(dist*1000).toFixed(1)} å…¬å°º)`;
                }
            }, (err) => {
                alert("å®šä½å¤±æ•—: " + err.message);
            });
        }

        
async function sendAttendance() {
    try {
        const resCheck = await fetch(`${ODOO_URL}/api/hr.attendance/check`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${ODOO_API_KEY}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                employee_id: EMPLOYEE_ID
            })
        });

        const checkResult = await resCheck.json();
        const actionType = checkResult.action === 'sign_in' ? 'check_in' : 'check_out';

        const res = await fetch(`${ODOO_URL}/api/hr.attendance`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${ODOO_API_KEY}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                employee_id: EMPLOYEE_ID,
                [actionType]: new Date().toISOString(),
                note: document.getElementById("note").value
            })
        });

        if (res.ok) {
            const actionText = actionType === 'check_in' ? 'ä¸Šç­' : 'ä¸‹ç­';
            document.getElementById("status").textContent += `\nğŸ‰ ${actionText}æ‰“å¡æˆåŠŸï¼`;
        } else {
            const err = await res.json();
            document.getElementById("status").textContent += `\nâŒ æ‰“å¡å¤±æ•—: ${err.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`;
        }
    } catch (e) {
        document.getElementById("status").textContent += `\nâŒ ç™¼ç”ŸéŒ¯èª¤: ${e.message}`;
    }
}

            try {
                const res = await fetch(`${ODOO_URL}/api/hr.attendance`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${ODOO_API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        employee_id: EMPLOYEE_ID,
                        check_in: new Date().toISOString()
                    })
                });

                if (res.ok) {
                    document.getElementById("status").textContent += "\nğŸ‰ æ‰“å¡æˆåŠŸï¼";
                } else {
                    const err = await res.json();
                    document.getElementById("status").textContent += 
                        `\nâŒ æ‰“å¡å¤±æ•—: ${err.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`;
                }
            } catch (e) {
                document.getElementById("status").textContent += `\nâŒ ç™¼ç”ŸéŒ¯èª¤: ${e.message}`;
            }
        }
    </script>
</body>
</html>
