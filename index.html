
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Odoo JSON-RPC æ‰“å¡ç³»çµ±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; padding: 2em; text-align: center; }
        input, button { padding: 0.8em; font-size: 1em; margin: 0.5em; width: 80%%; max-width: 400px; }
        #status { margin-top: 1.5em; font-weight: bold; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ“ å’Œå¾·æ‰“å¡ç³»çµ±ï¼ˆOdoo JSON-RPCï¼‰</h1>
    <input type="text" id="odoo_login" placeholder="è¼¸å…¥ Odoo å¸³è™Ÿï¼ˆEmailï¼‰"><br>
    <input type="password" id="odoo_password" placeholder="è¼¸å…¥ Odoo å¯†ç¢¼"><br>
    <input type="text" id="note" placeholder="æ‰“å¡å‚™è¨»ï¼ˆä¾‹å¦‚ï¼šå…¬å¸é–€å£ï¼‰"><br>
    <button onclick="handleClockIn()">é–‹å§‹æ‰“å¡</button>
    <div id="status"></div>

    <script>
        const ODOO_URL = "https://hotech.odoo.com"; // ä½ çš„ Odoo ç¶²å€
        const ODOO_DB = "hotech"; // ä½ çš„è³‡æ–™åº«åç¨±
        const ALLOWED_LAT = 25.04504;
        const ALLOWED_LON = 121.46676;
        const ALLOWED_DISTANCE_KM = 0.1;

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function odooLogin(login, password) {
            const res = await fetch(`${ODOO_URL}/web/session/authenticate`, {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    jsonrpc: "2.0",
                    params: { db: ODOO_DB, login: login, password: password }
                })
            });
            return res.json();
        }

        async function sendAttendanceNote(note) {
            const res = await fetch(`${ODOO_URL}/web/dataset/call_kw/hr.attendance/attendance_manual`, {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    jsonrpc: "2.0",
                    method: "call",
                    params: {
                        model: "hr.attendance",
                        method: "attendance_manual",
                        args: [{ note: note }],
                        kwargs: {}
                    }
                })
            });
            return res.json();
        }

        async function handleClockIn() {
            const login = document.getElementById("odoo_login").value;
            const password = document.getElementById("odoo_password").value;
            const note = document.getElementById("note").value;

            if (!login || !password) {
                document.getElementById("status").textContent = "è«‹å…ˆè¼¸å…¥ Odoo å¸³è™Ÿèˆ‡å¯†ç¢¼";
                return;
            }

            document.getElementById("status").textContent = "ğŸ” ç™»å…¥ Odoo ä¸­...";

            const loginResult = await odooLogin(login, password);
            if (!loginResult.result || !loginResult.result.uid) {
                document.getElementById("status").textContent = "âŒ Odoo ç™»å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªå¸³å¯†";
                return;
            }

            document.getElementById("status").textContent = "ğŸ“ å–å¾—å®šä½ä¸­...";
            if (!navigator.geolocation) {
                alert("æ­¤è£ç½®ä¸æ”¯æ´ GPS å®šä½");
                return;
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const dist = getDistance(lat, lon, ALLOWED_LAT, ALLOWED_LON);

                if (dist <= ALLOWED_DISTANCE_KM) {
                    document.getElementById("status").textContent = `âœ… ä½ç½®ç¢ºèªæˆåŠŸï¼šè·é›¢ ${(dist*1000).toFixed(1)} å…¬å°º\nğŸ“¨ å‚³é€æ‰“å¡ä¸­...`;
                    const res = await sendAttendanceNote(note);
                    if (res.result) {
                        const action = res.result.action === "sign_in" ? "ä¸Šç­" : "ä¸‹ç­";
                        document.getElementById("status").textContent += `\nğŸ‰ ${action}æ‰“å¡æˆåŠŸï¼`;
                    } else {
                        document.getElementById("status").textContent += "\nâŒ æ‰“å¡å¤±æ•—";
                    }
                } else {
                    document.getElementById("status").textContent = `âŒ ä½ ä¸åœ¨æ‰“å¡ç¯„åœå…§ï¼ˆè·é›¢ ${(dist*1000).toFixed(1)} å…¬å°ºï¼‰`;
                }
            }, (err) => {
                document.getElementById("status").textContent = "âŒ å®šä½å¤±æ•—ï¼š" + err.message;
            });
        }
    </script>
</body>
</html>
