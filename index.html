
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Odoo JSON-RPC 打卡系統</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; padding: 2em; text-align: center; }
        input, button { padding: 0.8em; font-size: 1em; margin: 0.5em; width: 80%%; max-width: 400px; }
        #status { margin-top: 1.5em; font-weight: bold; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>📍 和德打卡系統（Odoo JSON-RPC）</h1>
    <input type="text" id="odoo_login" placeholder="輸入 Odoo 帳號（Email）"><br>
    <input type="password" id="odoo_password" placeholder="輸入 Odoo 密碼"><br>
    <input type="text" id="note" placeholder="打卡備註（例如：公司門口）"><br>
    <button onclick="handleClockIn()">開始打卡</button>
    <div id="status"></div>

    <script>
        const ODOO_URL = "https://hotech.odoo.com"; // 你的 Odoo 網址
        const ODOO_DB = "hotech"; // 你的資料庫名稱
        const ALLOWED_LAT = 25.04504;
        const ALLOWED_LON = 121.46676;
        const ALLOWED_DISTANCE_KM = 0.1;

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function odooLogin(login, password) {
            const res = await fetch(`${ODOO_URL}/web/session/authenticate`, {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    jsonrpc: "2.0",
                    params: { db: ODOO_DB, login: login, password: password }
                })
            });
            return res.json();
        }

        async function sendAttendanceNote(note) {
            const res = await fetch(`${ODOO_URL}/web/dataset/call_kw/hr.attendance/attendance_manual`, {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    jsonrpc: "2.0",
                    method: "call",
                    params: {
                        model: "hr.attendance",
                        method: "attendance_manual",
                        args: [{ note: note }],
                        kwargs: {}
                    }
                })
            });
            return res.json();
        }

        async function handleClockIn() {
            const login = document.getElementById("odoo_login").value;
            const password = document.getElementById("odoo_password").value;
            const note = document.getElementById("note").value;

            if (!login || !password) {
                document.getElementById("status").textContent = "請先輸入 Odoo 帳號與密碼";
                return;
            }

            document.getElementById("status").textContent = "🔐 登入 Odoo 中...";

            const loginResult = await odooLogin(login, password);
            if (!loginResult.result || !loginResult.result.uid) {
                document.getElementById("status").textContent = "❌ Odoo 登入失敗，請確認帳密";
                return;
            }

            document.getElementById("status").textContent = "📍 取得定位中...";
            if (!navigator.geolocation) {
                alert("此裝置不支援 GPS 定位");
                return;
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const dist = getDistance(lat, lon, ALLOWED_LAT, ALLOWED_LON);

                if (dist <= ALLOWED_DISTANCE_KM) {
                    document.getElementById("status").textContent = `✅ 位置確認成功：距離 ${(dist*1000).toFixed(1)} 公尺\n📨 傳送打卡中...`;
                    const res = await sendAttendanceNote(note);
                    if (res.result) {
                        const action = res.result.action === "sign_in" ? "上班" : "下班";
                        document.getElementById("status").textContent += `\n🎉 ${action}打卡成功！`;
                    } else {
                        document.getElementById("status").textContent += "\n❌ 打卡失敗";
                    }
                } else {
                    document.getElementById("status").textContent = `❌ 你不在打卡範圍內（距離 ${(dist*1000).toFixed(1)} 公尺）`;
                }
            }, (err) => {
                document.getElementById("status").textContent = "❌ 定位失敗：" + err.message;
            });
        }
    </script>
</body>
</html>
